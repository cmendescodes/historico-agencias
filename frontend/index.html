<!-- <!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Hist√≥rico da Ag√™ncia</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>

<div class="container">
  <h1>Consulta de Ag√™ncia</h1>

  <div class="search">
    <input id="code" placeholder="C√≥digo da Ag√™ncia (ex: AG001)" />
    <button onclick="buscar()">Consultar</button>
  </div>

  <div id="result"></div>
</div>

<script>
async function buscar(codeParam) {
  const codeInput = document.getElementById("code");
  const result = document.getElementById("result");

  const code = codeParam || codeInput.value.trim();
  result.innerHTML = "";

  if (!code) return;

  const agencyRes = await fetch(`/api/agencies/${code}`);
  if (!agencyRes.ok) return result.innerHTML = "<p>Ag√™ncia n√£o encontrada</p>";
  const agency = await agencyRes.json();

  const historyRes = await fetch(`/api/agencies/${code}/history`);
  if (!historyRes.ok) return result.innerHTML = "<p>Hist√≥rico n√£o encontrado</p>";
  const history = await historyRes.json();

  if (!history.length) return result.innerHTML = "<p>Nenhum relat√≥rio encontrado.</p>";

  // Agrupa por refer√™ncia
  const grouped = {};
  history.forEach(h => {
    if (!grouped[h.reference]) grouped[h.reference] = { repasse: 0, credito: 0, pago: true };
    grouped[h.reference].repasse += Number(h.repasse);
    grouped[h.reference].credito += Number(h.credito);
    if (!h.pago) grouped[h.reference].pago = false;
  });

  const cards = Object.entries(grouped).map(([date, values]) => {
    const status = values.pago
      ? "Tudo em dia"
      : values.credito > 0
        ? "Cr√©dito em aberto"
        : values.repasse > 0
          ? "Repasse pendente"
          : "Tudo em dia";

    return `
      <div class="card">
        <h2>${agency.code}</h2>
        <h3>Relat√≥rio ${date}</h3>
        <p class="status ${values.pago ? "ok" : "alert"}">${status}</p>
        <div class="totals">
          <span>Repasse: <strong>R$ ${values.repasse.toFixed(2)}</strong></span>
          <span>Cr√©dito: <strong>R$ ${values.credito.toFixed(2)}</strong></span>
        </div>
      </div>
    `;
  });

  result.innerHTML = cards.join("");
}

// Atualiza automaticamente ao clicar em Pago no admin
window.addEventListener("reportUpdated", (e) => {
  const code = e.detail.code;
  if (window.buscar) {
    buscar(code); // atualiza os cards do index automaticamente
  }
});

</script>

</body>
</html> -->

<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NEXTUR Pay</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="icon" href="https://i.ibb.co/HDw5G2L6/file-0000000063d471f591f25e75880d3cc5-1.png" type="image/png">
</head>
<body>

<div id="region-gate" class="region-gate">
  <div class="region-card">
    <h1>NEXTUR
      <span class="nextur-digital">Pay</span>
    </h1>
    <div class="nextur-subtitle equipment-selector">
      <span class="label"></span>

      <div class="equipment-current">
        <span class="label">Equipamento:</span>
        <span class="value" id="equipamentoAtual">Escuna</span>

        <button class="btn-change" onclick="toggleEquipamentos()">
          Trocar
        </button>
      </div>

      <div class="equipment-dropdown" id="equipmentDropdown">
        <div class="equipment-item active">
          <span>Escuna</span>
        </div>

        <div class="equipment-item disabled">
          <span>Jipe</span>
          <em>Em breve</em>
        </div>

        <div class="equipment-item disabled">
          <span>Flexboat</span>
          <em>Em breve</em>
        </div>

        <div class="equipment-item disabled">
          <span>Lancha</span>
          <em>Em breve</em>
        </div>
      </div>
    </div>
    <p>Selecione a regi√£o para continuar</p>

    <div id="login-loader" class="login-loader" style="display:none;">
      <div class="loader-card">
        <div class="spinner"></div>
        <div class="loader-text">Validando acesso...</div>
      </div>
    </div>

    <div class="regions">
      <button class="region active" onclick="selecionarRegiao('ilhabela')">
        üü¢ Ilhabela
        <span>Dispon√≠vel</span>
      </button>

      <button class="region disabled">
        üü° Paraty
        <span>Em breve</span>
      </button>

      <button class="region disabled">
        üü° Angra
        <span>Em breve</span>
      </button>

      <button class="region disabled">
        üü° Bertioga
        <span>Em breve</span>
      </button>

      <div class="region-footer">
        <button class="footer-btnsup" onclick="abrirWhatsapp()">Suporte</button>
      </div>

    </div>
  </div>
</div>

<div class="system-context">
  <span>Regi√£o:</span>
  <strong>Ilhabela</strong>
  <span class="dot">‚Ä¢</span>
  <span>Equipamento:</span>
  <strong>Escuna</strong>
</div>

<div class="container">
  <h1>Consulta de saldo:</h1>

  <div class="search">
    <input id="code" placeholder="C√≥digo da Ag√™ncia (ex: AGENCIATUR)" />
    <button onclick="buscar()">Consultar</button>
  </div>

  <div id="result"></div>
</div>

<script>
const API_URL = "https://historico-agencias.onrender.com"; // Backend Render

async function buscar(codeParam) {
  const codeInput = document.getElementById("code");
  const result = document.getElementById("result");

  const code = codeParam || codeInput.value.trim();
  result.innerHTML = "";

  if (!code) return;

  // Mostra loader
  result.innerHTML = "<p>Carregando...</p>";

  try {
    // Busca ag√™ncia
    const agencyRes = await fetch(`${API_URL}/api/agencies/${code}`);
    if (!agencyRes.ok) throw new Error("Ag√™ncia n√£o encontrada");
    const agency = await agencyRes.json();

    // Busca hist√≥rico
    const historyRes = await fetch(`${API_URL}/api/agencies/${code}/history`);
    if (!historyRes.ok) throw new Error("Hist√≥rico n√£o encontrado");
    const history = await historyRes.json();

    if (!history.length) {
      result.innerHTML = "<p>Nenhum relat√≥rio encontrado.</p>";
      return;
    }

    // Agrupa por refer√™ncia
    const grouped = {};
    history.forEach(h => {
      if (!grouped[h.reference]) grouped[h.reference] = { repasse: 0, credito: 0, pago: true };
      grouped[h.reference].repasse += Number(h.repasse);
      grouped[h.reference].credito += Number(h.credito);
      if (!h.pago) grouped[h.reference].pago = false;
    });

    // Monta cards
    const cards = Object.entries(grouped).map(([date, values]) => {
      const status = values.pago
        ? "Tudo em dia"
        : values.credito > 0
          ? "Cr√©dito em aberto"
          : values.repasse > 0
            ? "Repasse pendente"
            : "Tudo em dia";

      return `
        <div class="card">
          <h2>${agency.code}</h2>
          <h3>Relat√≥rio ${date}</h3>
          <p class="status ${values.pago ? "ok" : "alert"}">${status}</p>
          <div class="totals">
            <span>Repasse: <strong>R$ ${values.repasse.toFixed(2)}</strong></span>
            <span>Cr√©dito: <strong>R$ ${values.credito.toFixed(2)}</strong></span>
          </div>
        </div>
      `;
    });

    result.innerHTML = cards.join("");

  } catch (err) {
    result.innerHTML = `<p style="color:red;">${err.message}</p>`;
  }
}

// Atualiza automaticamente ao clicar em Pago no admin
window.addEventListener("reportUpdated", (e) => {
  const code = e.detail.code;
  if (window.buscar) {
    buscar(code); // atualiza os cards do index automaticamente
  }
});

/* =========================
   EQUIPAMENTO (DROPDOWN)
========================= */
function toggleEquipamentos() {
  document.getElementById('equipmentDropdown').classList.toggle('open');
}

document.addEventListener('click', function (e) {
  const selector = document.querySelector('.equipment-selector');
  if (!selector.contains(e.target)) {
    document.getElementById('equipmentDropdown').classList.remove('open');
  }
});

/* Selecionar equipamento */
document.querySelectorAll(".equipment-item").forEach(item => {
  if (!item.classList.contains("disabled")) {
    item.addEventListener("click", () => {
      const value = item.querySelector("span").innerText;
      document.getElementById("equipamentoAtual").innerText = value;

      document.querySelectorAll(".equipment-item")
        .forEach(i => i.classList.remove("active"));

      item.classList.add("active");
      document.getElementById("equipmentDropdown").classList.remove("open");
    });
  }
});

/* Fecha dropdown clicando fora */
document.addEventListener("click", (e) => {
  const selector = document.querySelector(".equipment-selector");
  if (!selector.contains(e.target)) {
    document.getElementById("equipmentDropdown").classList.remove("open");
  }
});

/* =========================
   SELE√á√ÉO DE REGI√ÉO
========================= */
function selecionarRegiao(regiao) {
  const loader = document.getElementById("login-loader");
  const gate = document.getElementById("region-gate");

  // Evita clique m√∫ltiplo
  if (loader.classList.contains("show")) return;

  loader.style.display = "flex";
  setTimeout(() => loader.classList.add("show"), 10);

  // Simula valida√ß√£o / redirect
  setTimeout(() => {
    gate.classList.add("fade-out");

    // üîÅ ajuste aqui para a rota real
    setTimeout(() => {
      window.location.href = "/" + regiao;
      // ex: /ilhabela
    }, 600);

  }, 1500);
}

/* =========================
   BOT√ïES AUXILIARES
========================= */
function abrirTermos() {
  alert("Abrir termos (implementar modal)");
}

function abrirCadastro() {
  alert("Abrir cadastro (implementar modal)");
}

function abrirWhatsapp() {
  window.open("https://wa.me/5599999999999", "_blank");
}

/* =========================
   TOOLTIP MOBILE
========================= */
function mostrarTooltip(btn) {
  btn.classList.toggle("active");

  setTimeout(() => {
    btn.classList.remove("active");
  }, 2500);
}

  document.body.classList.add('gate-open');

  function selecionarRegiao(regiao) {
    if (!regiao) return;

    const loader = document.getElementById('login-loader');
    const gate = document.getElementById('region-gate');
    const systemContext = document.querySelector('.system-context');
    const container = document.querySelector('.container');

    // mostra loader
    loader.style.display = 'flex';

    setTimeout(() => {
      // atualiza system-context
      systemContext.querySelector('strong').innerText =
        regiao.charAt(0).toUpperCase() + regiao.slice(1);

      // fecha gate
      gate.classList.add('hidden');
      document.body.classList.remove('gate-open');

      // libera sistema
      systemContext.classList.add('visible');
      container.classList.add('visible');

      loader.style.display = 'none';
    }, 1200); // delay elegante
  }



</script>

<a href="https://nextur.digital"
   target="_blank"
   class="floating-site-button"
   aria-label="Acessar site oficial">

  <img src="https://i.ibb.co/B5DgqfT1/file-0000000063d471f591f25e75880d3cc5-1-removebg-preview.png" alt="Site Oficial">
</a>

</body>
</html>

