<!-- <!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Histórico da Agência</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>

<div class="container">
  <h1>Consulta de Agência</h1>

  <div class="search">
    <input id="code" placeholder="Código da Agência (ex: AG001)" />
    <button onclick="buscar()">Consultar</button>
  </div>

  <div id="result"></div>
</div>

<script>
async function buscar(codeParam) {
  const codeInput = document.getElementById("code");
  const result = document.getElementById("result");

  const code = codeParam || codeInput.value.trim();
  result.innerHTML = "";

  if (!code) return;

  const agencyRes = await fetch(`/api/agencies/${code}`);
  if (!agencyRes.ok) return result.innerHTML = "<p>Agência não encontrada</p>";
  const agency = await agencyRes.json();

  const historyRes = await fetch(`/api/agencies/${code}/history`);
  if (!historyRes.ok) return result.innerHTML = "<p>Histórico não encontrado</p>";
  const history = await historyRes.json();

  if (!history.length) return result.innerHTML = "<p>Nenhum relatório encontrado.</p>";

  // Agrupa por referência
  const grouped = {};
  history.forEach(h => {
    if (!grouped[h.reference]) grouped[h.reference] = { repasse: 0, credito: 0, pago: true };
    grouped[h.reference].repasse += Number(h.repasse);
    grouped[h.reference].credito += Number(h.credito);
    if (!h.pago) grouped[h.reference].pago = false;
  });

  const cards = Object.entries(grouped).map(([date, values]) => {
    const status = values.pago
      ? "Tudo em dia"
      : values.credito > 0
        ? "Crédito em aberto"
        : values.repasse > 0
          ? "Repasse pendente"
          : "Tudo em dia";

    return `
      <div class="card">
        <h2>${agency.code}</h2>
        <h3>Relatório ${date}</h3>
        <p class="status ${values.pago ? "ok" : "alert"}">${status}</p>
        <div class="totals">
          <span>Repasse: <strong>R$ ${values.repasse.toFixed(2)}</strong></span>
          <span>Crédito: <strong>R$ ${values.credito.toFixed(2)}</strong></span>
        </div>
      </div>
    `;
  });

  result.innerHTML = cards.join("");
}

// Atualiza automaticamente ao clicar em Pago no admin
window.addEventListener("reportUpdated", (e) => {
  const code = e.detail.code;
  if (window.buscar) {
    buscar(code); // atualiza os cards do index automaticamente
  }
});

</script>

</body>
</html> -->

<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NEXTUR® Financeiro</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="icon" href="https://i.ibb.co/HDw5G2L6/file-0000000063d471f591f25e75880d3cc5-1.png" type="image/png">
</head>
<body>

<div class="system-context">
  <span>Região:</span>
  <strong>Ilhabela</strong>
  <span class="dot">•</span>
  <span>Equipamento:</span>
  <strong>Escuna</strong>
</div>

<div class="container">
  <h1>Histórico Financeiro</h1>

  <div class="search">
    <input id="code" placeholder="Código da Agência (ex: AGENCIATUR)" />
    <button onclick="buscar()">Consultar</button>
  </div>

  <div id="result"></div>
</div>

<script>
const API_URL = "https://historico-agencias.onrender.com"; // Backend Render

async function buscar(codeParam) {
  const codeInput = document.getElementById("code");
  const result = document.getElementById("result");

  const code = codeParam || codeInput.value.trim();
  result.innerHTML = "";

  if (!code) return;

  // Mostra loader
  result.innerHTML = "<p>Carregando...</p>";

  try {
    // Busca agência
    const agencyRes = await fetch(`${API_URL}/api/agencies/${code}`);
    if (!agencyRes.ok) throw new Error("Agência não encontrada");
    const agency = await agencyRes.json();

    // Busca histórico
    const historyRes = await fetch(`${API_URL}/api/agencies/${code}/history`);
    if (!historyRes.ok) throw new Error("Histórico não encontrado");
    const history = await historyRes.json();

    if (!history.length) {
      result.innerHTML = "<p>Nenhum relatório encontrado.</p>";
      return;
    }

    // Agrupa por referência
    const grouped = {};
    history.forEach(h => {
      if (!grouped[h.reference]) grouped[h.reference] = { repasse: 0, credito: 0, pago: true };
      grouped[h.reference].repasse += Number(h.repasse);
      grouped[h.reference].credito += Number(h.credito);
      if (!h.pago) grouped[h.reference].pago = false;
    });

    // Monta cards
    const cards = Object.entries(grouped).map(([date, values]) => {
      const status = values.pago
        ? "Tudo em dia"
        : values.credito > 0
          ? "Crédito em aberto"
          : values.repasse > 0
            ? "Repasse pendente"
            : "Tudo em dia";

      return `
        <div class="card">
          <h2>${agency.code}</h2>
          <h3>Relatório ${date}</h3>
          <p class="status ${values.pago ? "ok" : "alert"}">${status}</p>
          <div class="totals">
            <span>Repasse: <strong>R$ ${values.repasse.toFixed(2)}</strong></span>
            <span>Crédito: <strong>R$ ${values.credito.toFixed(2)}</strong></span>
          </div>
        </div>
      `;
    });

    result.innerHTML = cards.join("");

  } catch (err) {
    result.innerHTML = `<p style="color:red;">${err.message}</p>`;
  }
}

// Atualiza automaticamente ao clicar em Pago no admin
window.addEventListener("reportUpdated", (e) => {
  const code = e.detail.code;
  if (window.buscar) {
    buscar(code); // atualiza os cards do index automaticamente
  }
});
</script>

<a href="https://nextur.digital"
   target="_blank"
   class="floating-site-button"
   aria-label="Acessar site oficial">

  <img src="https://i.ibb.co/B5DgqfT1/file-0000000063d471f591f25e75880d3cc5-1-removebg-preview.png" alt="Site Oficial">
</a>

</body>
</html>

