<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<title>Admin – Relatórios</title>
<link rel="stylesheet" href="style.css" />
<style>
  /* ====== Login Overlay ====== */
  #loginOverlay {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(15,23,42,0.95);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    flex-direction: column;
    color: #fff;
    font-family: "Segoe UI", sans-serif;
  }
  #loginBox {
    background: #1e293b;
    padding: 40px 30px;
    border-radius: 16px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.5);
    text-align: center;
    width: 320px;
  }
  #loginBox h2 { margin-bottom: 20px; }
  #loginBox input {
    width: 100%;
    padding: 12px;
    border-radius: 8px;
    border: none;
    margin-bottom: 16px;
    font-size: 1rem;
  }
  #loginBox button {
    width: 100%;
    padding: 12px;
    background: linear-gradient(135deg,#1fb6ff,#2563eb);
    color: #fff;
    font-weight: bold;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: transform 0.2s ease, background 0.2s ease;
  }
  #loginBox button:hover { background: linear-gradient(135deg,#0da5e9,#1d4ed8); transform: translateY(-1px); }
  #loginLoading {
    display: none;
    height: 4px;
    width: 100%;
    background: rgba(255,255,255,0.1);
    border-radius: 2px;
    overflow: hidden;
    margin-top: 12px;
  }
  #loginLoading div {
    height: 100%;
    width: 0;
    background: linear-gradient(90deg, #2563eb, #1d4ed8);
    animation: loadAnim 1.5s linear infinite;
  }
  @keyframes loadAnim {
    0% { width: 0%; }
    50% { width: 100%; }
    100% { width: 0%; }
  }

/* ====== Busca / Pesquisa Admin ====== */
.search {
  display: flex;
  gap: 12px;
  align-items: center;
  flex-wrap: wrap;

  margin-bottom: 30px;
  padding: 16px 18px;

  background: rgba(2, 6, 23, 0.75);
  border: 1px solid #1e293b;
  border-radius: 14px;
  box-shadow: 0 4px 14px rgba(0,0,0,0.35);
}

.search input {
  flex: 1;
  min-width: 220px;

  padding: 12px 14px;
  font-size: 0.95rem;

  color: #e5e7eb;
  background: #020617;

  border: 1px solid #1e293b;
  border-radius: 10px;
  outline: none;

  transition: border 0.2s ease, box-shadow 0.2s ease;
}

.search input::placeholder {
  color: #94a3b8;
}

.search input:focus {
  border-color: #2563eb;
  box-shadow: 0 0 0 2px rgba(37,99,235,0.35);
}

.search button {
  padding: 12px 18px;
  font-size: 0.9rem;
  font-weight: 600;

  color: #fff;
  background: linear-gradient(135deg, #1fb6ff, #2563eb);

  border: none;
  border-radius: 999px;
  cursor: pointer;

  transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
}

.search button:hover {
  background: linear-gradient(135deg, #0da5e9, #1d4ed8);
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(37,99,235,0.45);
}

/* Mobile */
@media (max-width: 640px) {
  .search {
    flex-direction: column;
    align-items: stretch;
  }

  .search button {
    width: 100%;
    text-align: center;
  }
}


  /* ====== Restante do Admin ====== */
  body { font-family: "Segoe UI", sans-serif; background: #0f172a; color: #e5e7eb; margin: 0; }
  .admin-header { display: flex; gap: 15px; padding: 20px; border-bottom: 1px solid #1e293b; background: linear-gradient(135deg,#020617,#0f172a); align-items: center; flex-wrap: wrap; }
  .container { max-width: 1400px; margin: 40px auto; padding: 20px; }
  .card { margin-bottom: 25px; border-radius: 16px; padding: 20px; background: rgba(2,6,23,0.85); border: 1px solid #1e293b; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
  .subcard { padding: 14px; margin-top: 12px; border-radius: 12px; border: 1px dashed #1e293b; background: rgba(2,6,23,0.65); transition: transform 0.2s ease, box-shadow 0.2s ease; }
  .subcard:hover { transform: translateY(-2px); box-shadow: 0 6px 14px rgba(0,0,0,0.35); }
  .row { display: grid; grid-template-columns: 1fr 1fr; padding: 6px 0; border-bottom: 1px dashed #1e293b; font-size: 0.95rem; }
  .row:last-child { border-bottom: none; }
  .status.ok { color: #22c55e; font-weight: bold; text-shadow: 0 0 6px #22c55e80; }
  .status.alert { color: #facc15; font-weight: bold; text-shadow: 0 0 6px #facc1580; }
  .btnPago { padding: 6px 14px; background: linear-gradient(135deg,#1fb6ff,#2563eb); color: #fff; border: none; border-radius: 8px; cursor: pointer; margin-top: 8px; font-weight: bold; transition: transform 0.2s ease, background 0.2s ease; }
  .btnPago:hover { background: linear-gradient(135deg,#0da5e9,#1d4ed8); transform: translateY(-1px); }
  #notifications { position: fixed; top: 20px; right: 20px; display: flex; flex-direction: column; gap: 12px; z-index: 9999; }
  .notif { padding: 14px 20px; border-radius: 12px; color: #fff; font-weight: 500; box-shadow: 0 4px 12px rgba(0,0,0,0.3); backdrop-filter: blur(4px); opacity: 0.95; min-width: 200px; }
  .notif.success { background: #22c55e; }
  .notif.error { background: #ef4444; }
  .notif.info { background: #2563eb; }
</style>
</head>
<body>

<!-- Login Overlay -->
<div id="loginOverlay">
  <div id="loginBox">
    <h2>Login Administrativo</h2>
    <input type="password" id="loginPassword" placeholder="Digite a senha" />
    <button onclick="login()">Entrar</button>
    <div id="loginLoading"><div></div></div>
    <p id="loginError" style="color:#f87171; margin-top:10px; display:none;">Senha incorreta!</p>
  </div>
</div>

<!-- Admin Content -->
<div id="adminContent" style="display:none;">
  <header class="admin-header">
    <h1>Painel Administrativo - Escuna (Coletivo)</h1>
    <div>
      <input type="file" id="pdfFile" />
      <button onclick="upload()">Upload PDF</button>
      <div id="loadingBar"><div></div></div>
    </div>
  </header>

  <div class="container">
    <div class="search">
      <input id="code" placeholder="Código da Agência (ex: AG001)" />
      <button onclick="loadAgency()">Carregar Agência</button>
    </div>

    <main id="adminResult"></main>
  </div>

  <div id="notifications"></div>
</div>

<script>
const PASSWORD = "adm123";

// ====== Login ======
function login() {
  const input = document.getElementById("loginPassword").value;
  const error = document.getElementById("loginError");
  const loading = document.getElementById("loginLoading");
  error.style.display = "none";
  loading.style.display = "block";

  setTimeout(() => {
    loading.style.display = "none";
    if (input === PASSWORD) {
      document.getElementById("loginOverlay").style.display = "none";
      document.getElementById("adminContent").style.display = "block";
    } else {
      error.style.display = "block";
    }
  }, 1000); // animação de carregamento
}

// ====== Notificações ======
function notify(msg, type="info", duration=3000) {
  const n = document.createElement("div");
  n.className = `notif ${type}`;
  n.textContent = msg;
  document.getElementById("notifications").appendChild(n);
  setTimeout(() => n.remove(), duration);
}

// ====== PDF Upload ======
async function upload() {
  const file = document.getElementById("pdfFile").files[0];
  if (!file) return notify("Selecione um PDF", "error");

  const form = new FormData();
  form.append("file", file);

  const loading = document.getElementById("loadingBar");
  loading.style.display = "block";

  try {
    const res = await fetch(`https://historico-agencias.onrender.com/api/admin/upload`, { method: "POST", body: form });
    if (!res.ok) {
      const text = await res.text();
      return notify(text, "error");
    }
    notify("PDF processado com sucesso", "success");
    loadAllAgencies();
  } catch(e) {
    notify("Erro no upload do PDF", "error");
  } finally {
    loading.style.display = "none";
  }
}

// ====== Carregar Agência ======
async function loadAgency() {
  const code = document.getElementById("code").value.trim();
  const container = document.getElementById("adminResult");
  container.innerHTML = "";
  if (!code) return;

  container.innerHTML = "<p>Carregando...</p>";
  try {
    const res = await fetch(`https://historico-agencias.onrender.com/api/agencies/${code}/history`);
    if (!res.ok) throw new Error("Agência não encontrada");
    const history = await res.json();
    container.innerHTML = "";
    if (!history.length) { container.innerHTML = "<p>Nenhum relatório encontrado.</p>"; return; }
    renderAgencyCard(code, history, container);
  } catch (err) {
    container.innerHTML = `<p style="color:red;">${err.message}</p>`;
  }
}

// ====== Render Cards ======
function renderAgencyCard(code, history, container) {
  const grouped = {};
  history.forEach(h => {
    if (!grouped[h.reference]) grouped[h.reference] = { repasse: 0, credito: 0, pago: true };
    grouped[h.reference].repasse += Number(h.repasse);
    grouped[h.reference].credito += Number(h.credito);
    if (!h.pago) grouped[h.reference].pago = false;
  });

  const card = document.createElement("div");
  card.className = "card";
  card.innerHTML = `<h2>Agência ${code}</h2>`;
  container.appendChild(card);

  Object.entries(grouped).forEach(([date, values]) => {
    const sub = document.createElement("div");
    sub.className = "subcard";
    const status = values.pago ? "Tudo em dia" : values.credito>0 ? "Crédito pendente" : values.repasse>0 ? "Repasse pendente" : "Tudo em dia";
    sub.innerHTML = `<h3>Relatório ${date}</h3>
      <div class="row"><span>Repasse</span><span>R$ ${values.repasse.toFixed(2)}</span></div>
      <div class="row"><span>Crédito</span><span>R$ ${values.credito.toFixed(2)}</span></div>
      <p class="status ${values.pago?"ok":"alert"}">${status}</p>
      ${!values.pago?`<button class="btnPago" type="button">Pago</button>`:""}`;
    card.appendChild(sub);

    if (!values.pago) {
      const btn = sub.querySelector(".btnPago");
      btn.addEventListener("click", async()=>{ await updateReportStatus(code,date); });
    }
  });
}

// ====== Atualiza Status ======
async function updateReportStatus(code, reference) {
  try {
    const res = await fetch(`https://historico-agencias.onrender.com/api/admin/report-status`, {
      method:"PATCH",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ agency_code: code, reference, pago:true })
    });
    if(!res.ok){ const text = await res.text(); return notify("Erro: "+text,"error"); }

    document.querySelectorAll(".subcard").forEach(sub=>{
      const h3 = sub.querySelector("h3");
      if(h3 && h3.textContent.includes(reference)){
        const statusEl = sub.querySelector(".status");
        statusEl.textContent="Tudo em dia";
        statusEl.classList.remove("alert");
        statusEl.classList.add("ok");
        const btn = sub.querySelector(".btnPago"); if(btn) btn.remove();
      }
    });
    notify(`Status do relatório ${reference} atualizado`, "success");
  } catch(e){ notify("Erro ao atualizar status","error"); }
}
</script>

</body>
</html>


<!-- <!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Admin – Relatórios</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    /* Loading bar */
    #loadingBar {
      display: none;
      width: 100%;
      height: 6px;
      background: rgba(255,255,255,0.1);
      border-radius: 3px;
      overflow: hidden;
      margin-top: 8px;
    }
    #loadingBar div {
      height: 100%;
      width: 0;
      background: linear-gradient(90deg, #2563eb, #1d4ed8);
      animation: loading 2s linear infinite;
    }
    @keyframes loading {
      0% { width: 0%; }
      50% { width: 100%; }
      100% { width: 0%; }
    }

    /* Notificações */
    #notifications {
      position: fixed;
      top: 20px;
      right: 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      z-index: 9999;
    }
    .notif {
      padding: 14px 20px;
      border-radius: 12px;
      color: #fff;
      font-weight: 500;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      backdrop-filter: blur(4px);
      opacity: 0.95;
      min-width: 200px;
    }
    .notif.success { background: #22c55e; }
    .notif.error { background: #ef4444; }
    .notif.info { background: #2563eb; }

    /* Mobile responsiveness */
    @media (max-width: 768px) {
      .admin-header { flex-direction: column; gap: 10px; }
      .search { flex-direction: column; gap: 10px; }
      .row { grid-template-columns: 1fr 1fr; gap: 8px; }
      .btnPago { width: 100%; }
    }
  </style>
</head>
<body>

<header class="admin-header">
  <h1>Painel Administrativo - Escuna (Coletivo)</h1>
  <div>
    <input type="file" id="pdfFile" />
    <button onclick="upload()">Upload PDF</button>
    <div id="loadingBar"><div></div></div>
  </div>
</header>

<div class="container">
  <div class="search">
    <input id="code" placeholder="Código da Agência (ex: AG001)" />
    <button onclick="loadAgency()">Carregar Agência</button>
  </div>

  <main id="adminResult"></main>
</div>






<!-- <!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Admin – Relatórios</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .btnPago {
      padding: 6px 12px;
      background: #1fb6ff;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 5px;
    }
    .btnPago:hover {
      background: #0da5e9;
    }
    .card { margin-bottom: 20px; border: 1px solid #ccc; padding: 10px; border-radius: 6px; }
    .subcard { padding: 10px; border-top: 1px solid #eee; margin-top: 5px; }
    .status.ok { color: green; font-weight: bold; }
    .status.alert { color: red; font-weight: bold; }
  </style>
</head>
<body>

<header class="admin-header">
  <h1>Painel Administrativo</h1>

  <input type="file" id="pdfFile" />
  <button onclick="upload()">Upload PDF</button>
</header>

<div class="container">
  <div class="search">
    <input id="code" placeholder="Código da Agência (ex: AG001)" />
    <button onclick="load()">Carregar Agência</button>
  </div>

  <main id="adminResult"></main>
</div>

<script>
async function upload() {
  const file = document.getElementById("pdfFile").files[0];
  if (!file) return alert("Selecione um PDF");

  const form = new FormData();
  form.append("file", file);

  const res = await fetch("/api/admin/upload", { method: "POST", body: form });

  if (!res.ok) {
    const text = await res.text();
    return alert(text);
  }

  alert("PDF processado com sucesso");
}

async function load() {
  const code = document.getElementById("code").value.trim();
  const container = document.getElementById("adminResult");
  container.innerHTML = "";

  if (!code) return;

  // Busca o histórico da agência
  const historyRes = await fetch(`/api/agencies/${code}/history`);
  if (!historyRes.ok) {
    container.innerHTML = "<p>Agência não encontrada</p>";
    return;
  }

  const history = await historyRes.json();
  if (!history.length) {
    container.innerHTML = "<p>Nenhum relatório encontrado.</p>";
    return;
  }

  // Agrupa por referência
  const grouped = {};
  history.forEach(h => {
    if (!grouped[h.reference]) grouped[h.reference] = { repasse: 0, credito: 0, pago: true };
    grouped[h.reference].repasse += Number(h.repasse);
    grouped[h.reference].credito += Number(h.credito);
    // Se algum registro ainda não estiver pago, a referência fica não paga
    if (!h.pago) grouped[h.reference].pago = false;
  });

  const card = document.createElement("div");
  card.className = "card";
  card.innerHTML = `<h2>${code}</h2>`;

  Object.entries(grouped).forEach(([date, values]) => {
    const sub = document.createElement("div");
    sub.className = "subcard";

    // Determina o status do card
    const status = values.pago
      ? "Tudo em dia"
      : values.credito > 0
        ? "Crédito pendente"
        : values.repasse > 0
          ? "Repasse pendente"
          : "Tudo em dia";

    sub.innerHTML = `
      <h3>Relatório ${date}</h3>
      <div class="row"><span>Repasse</span><span>R$ ${values.repasse.toFixed(2)}</span></div>
      <div class="row"><span>Crédito</span><span>R$ ${values.credito.toFixed(2)}</span></div>
      <p class="status ${values.pago ? "ok" : "alert"}">${status}</p>
      ${!values.pago ? `<button class="btnPago" type="button">Pago</button>` : ""}
    `;

    card.appendChild(sub);

    // Adiciona listener ao botão Pago
    if (!values.pago) {
      const btn = sub.querySelector(".btnPago");
      btn.addEventListener("click", async (e) => {
        e.preventDefault();
        // Atualiza todos os reservation_code da reference
        await updateReportStatus(code, date);
      });
    }
  });

  container.appendChild(card);
}


// PATCH para marcar todos os reservation_code da reference como pago
async function updateReportStatus(code, reference) {
  const res = await fetch("/api/admin/report-status", {
    method: "PATCH",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ agency_code: code, reference, pago: true })
  });

  if (!res.ok) {
    const text = await res.text();
    return alert("Erro ao atualizar status: " + text);
  }

  // Atualiza visualmente o card do admin
  const subcards = document.querySelectorAll(".subcard");
  subcards.forEach(sub => {
    const h3 = sub.querySelector("h3");
    if (h3 && h3.textContent.includes(reference)) {
      const statusEl = sub.querySelector(".status");
      statusEl.textContent = "Tudo em dia";
      statusEl.classList.remove("alert");
      statusEl.classList.add("ok");

      const btn = sub.querySelector(".btnPago");
      if (btn) btn.remove();
    }
  });

  // Notifica o index para atualizar automaticamente
  window.dispatchEvent(new CustomEvent("reportUpdated", { detail: { code } }));
}



</script>

</body>
</html> -->

<!-- <!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<title>Admin – Relatórios</title>
<link rel="stylesheet" href="style.css" />
<style>
  /* ====== Body & Container ====== */
  body { font-family: "Segoe UI", sans-serif; background: #0f172a; color: #e5e7eb; margin: 0; }
  .container { max-width: 1400px; margin: 40px auto; padding: 20px; }

  /* ====== Header ====== */
  .admin-header {
    display: flex;
    gap: 15px;
    padding: 20px;
    border-bottom: 1px solid #1e293b;
    background: linear-gradient(135deg,#020617,#0f172a);
    align-items: center;
  }
  .admin-header h1 { margin: 0; font-size: 1.8rem; }

  /* ====== Cards ====== */
  .card {
    margin-bottom: 25px;
    border-radius: 16px;
    padding: 20px;
    background: rgba(2,6,23,0.85);
    border: 1px solid #1e293b;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  }
  .subcard {
    padding: 14px;
    margin-top: 12px;
    border-radius: 12px;
    border: 1px dashed #1e293b;
    background: rgba(2,6,23,0.65);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }
  .subcard:hover { transform: translateY(-2px); box-shadow: 0 6px 14px rgba(0,0,0,0.35); }

  /* ====== Rows ====== */
  .row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    padding: 6px 0;
    border-bottom: 1px dashed #1e293b;
    font-size: 0.95rem;
  }
  .row:last-child { border-bottom: none; }

  /* ====== Status ====== */
  .status.ok { color: #22c55e; font-weight: bold; text-shadow: 0 0 6px #22c55e80; }
  .status.alert { color: #facc15; font-weight: bold; text-shadow: 0 0 6px #facc1580; }

  /* ====== Buttons ====== */
  .btnPago {
    padding: 6px 14px;
    background: linear-gradient(135deg,#1fb6ff,#2563eb);
    color: #fff;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    margin-top: 8px;
    font-weight: bold;
    transition: transform 0.2s ease, background 0.2s ease;
  }
  .btnPago:hover { background: linear-gradient(135deg,#0da5e9,#1d4ed8); transform: translateY(-1px); }

  /* ====== Loader ====== */
  #adminResult p { font-size: 1rem; text-align: center; margin: 20px 0; }
</style>
</head>
<body>

<header class="admin-header">
  <h1>Painel Administrativo</h1>
  <input type="file" id="pdfFile" />
  <button onclick="upload()">Upload PDF</button>
</header>

<div class="container" id="adminResult"></div>

<script>
async function upload() {
  const file = document.getElementById("pdfFile").files[0];
  if (!file) return alert("Selecione um PDF");

  const form = new FormData();
  form.append("file", file);

  const res = await fetch("/api/admin/upload", { method: "POST", body: form });
  if (!res.ok) {
    const text = await res.text();
    return alert(text);
  }

  alert("PDF processado com sucesso");
  loadAllAgencies(); // recarrega todas as agências após upload
}

// ====== Carrega todas as agências ======
async function loadAllAgencies() {
  const container = document.getElementById("adminResult");
  container.innerHTML = "<p>Carregando todas as agências...</p>";

  try {
    const res = await fetch("/api/agencies");
    const text = await res.text(); // pega o retorno bruto
    let agencies = [];
    try {
      agencies = JSON.parse(text); // tenta parsear JSON
    } catch (e) {
      throw new Error("Retorno do servidor não é JSON: " + text.substring(0,100));
    }

    container.innerHTML = "";
    for (const agency of agencies) {
      await loadAgencyReports(agency.code, container);
    }
  } catch (err) {
    container.innerHTML = `<p>Erro ao carregar agências: ${err.message}</p>`;
  }
}


// ====== Carrega relatórios de cada agência ======
async function loadAgencyReports(code, container) {
  try {
    const historyRes = await fetch(`/api/agencies/${code}/history`);
    if (!historyRes.ok) throw new Error(historyRes.statusText);

    const history = await historyRes.json();
    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `<h2>Agência ${code}</h2>`;

    if (!history.length) {
      card.innerHTML += "<p>Nenhum relatório encontrado.</p>";
      container.appendChild(card);
      return;
    }

    const grouped = {};
    history.forEach(h => {
      if (!grouped[h.reference]) grouped[h.reference] = { repasse: 0, credito: 0, pago: true };
      grouped[h.reference].repasse += Number(h.repasse);
      grouped[h.reference].credito += Number(h.credito);
      if (!h.pago) grouped[h.reference].pago = false;
    });

    Object.entries(grouped).forEach(([date, values]) => {
      const sub = document.createElement("div");
      sub.className = "subcard";

      const status = values.pago
        ? "Tudo em dia"
        : values.credito > 0
          ? "Crédito pendente"
          : values.repasse > 0
            ? "Repasse pendente"
            : "Tudo em dia";

      sub.innerHTML = `
        <h3>Relatório ${date}</h3>
        <div class="row"><span>Repasse</span><span>R$ ${values.repasse.toFixed(2)}</span></div>
        <div class="row"><span>Crédito</span><span>R$ ${values.credito.toFixed(2)}</span></div>
        <p class="status ${values.pago ? "ok" : "alert"}">${status}</p>
        ${!values.pago ? `<button class="btnPago" type="button">Pago</button>` : ""}
      `;

      card.appendChild(sub);

      if (!values.pago) {
        const btn = sub.querySelector(".btnPago");
        btn.addEventListener("click", async () => {
          await updateReportStatus(code, date);
        });
      }
    });

    container.appendChild(card);
  } catch (err) {
    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `<h2>${code}</h2><p>Erro ao carregar relatórios: ${err.message}</p>`;
    container.appendChild(card);
  }
}

// ====== Atualiza status "Pago" ======
async function updateReportStatus(code, reference) {
  try {
    const res = await fetch("/api/admin/report-status", {
      method: "PATCH",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ agency_code: code, reference, status: true })
    });

    if (!res.ok) throw new Error(await res.text());

    const subcards = document.querySelectorAll(".subcard");
    subcards.forEach(sub => {
      const h3 = sub.querySelector("h3");
      if (h3 && h3.textContent.includes(reference)) {
        const statusEl = sub.querySelector(".status");
        statusEl.textContent = "Tudo em dia";
        statusEl.classList.remove("alert");
        statusEl.classList.add("ok");
        const btn = sub.querySelector(".btnPago");
        if (btn) btn.remove();
      }
    });
  } catch (err) {
    alert("Erro ao atualizar status: " + err.message);
  }
}

// ====== Carrega tudo ao abrir ======
window.addEventListener("load", loadAllAgencies);
</script>

</body>
</html> -->

